<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>InterviewAI</title>
    
    <!-- Скрипт для предотвращения моргания светлой темы при загрузке (FOUC) -->
    <script>
        if (localStorage.getItem('app_color_mode') === 'dark' || (!('app_color_mode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Настройка кастомных цветов для Tailwind (включая "Тепло-темную" палитру) -->
    <script>
        tailwind.config = {
            darkMode: 'class', // Включаем поддержку class="dark"
            theme: {
                extend: {
                    colors: {
                        brand: {
                            main: 'var(--brand-main)',
                            hover: 'var(--brand-hover)',
                            light: 'var(--brand-light)',
                            gradStart: 'var(--brand-grad-start)'
                        },
                        warm: {
                            base: '#1e1c1a',   // Основной фон (очень теплый темно-коричневый/серый)
                            surface: '#272422', // Карточки, модалки
                            alt: '#302d2b',    // Инпуты, вторичные панели
                            border: '#3d3936', // Границы
                        }
                    }
                }
            }
        }
    </script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        /* Системные переменные для цветовых тем */
        :root {
            /* Emerald (Изумрудная - по умолчанию) */
            --brand-main: #059669; 
            --brand-hover: #047857;
            --brand-light: #ecfdf5;
            --brand-grad-start: #34d399;
        }
        [data-theme="blue"] {
            --brand-main: #2563eb; 
            --brand-hover: #1d4ed8; 
            --brand-light: #eff6ff; 
            --brand-grad-start: #60a5fa;
        }
        [data-theme="violet"] {
            --brand-main: #7c3aed; 
            --brand-hover: #6d28d9; 
            --brand-light: #f5f3ff; 
            --brand-grad-start: #a78bfa; 
        }
        [data-theme="rose"] {
            --brand-main: #e11d48; 
            --brand-hover: #be123c; 
            --brand-light: #fff1f2; 
            --brand-grad-start: #fb7185; 
        }
        [data-theme="amber"] {
            --brand-main: #d97706; 
            --brand-hover: #b45309; 
            --brand-light: #fffbeb; 
            --brand-grad-start: #fbbf24; 
        }

        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s ease, color 0.3s ease; }
        
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        .slide-up { animation: slideUp 0.3s ease-out forwards; }
        .scale-in { animation: scaleIn 0.2s ease-out forwards; }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Анимации для карточек */
        @keyframes slideOutLeft {
            from { transform: translateX(0) rotate(0); opacity: 1; }
            to { transform: translateX(-120%) rotate(-10deg); opacity: 0; }
        }
        @keyframes slideOutRight {
            from { transform: translateX(0) rotate(0); opacity: 1; }
            to { transform: translateX(120%) rotate(10deg); opacity: 0; }
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .card-exit-left { animation: slideOutLeft 0.4s cubic-bezier(0.45, 0, 0.55, 1) forwards; }
        .card-exit-right { animation: slideOutRight 0.4s cubic-bezier(0.45, 0, 0.55, 1) forwards; }
        .card-enter { animation: slideInRight 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .feedback-enter { animation: slideInUp 0.4s ease-out forwards; }

        .custom-bottom-nav {
            bottom: calc(env(safe-area-inset-bottom) + 16px);
        }

        .loading-dots:after {
            content: ' .';
            animation: dots 1s steps(5, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ' .'; }
            40% { content: ' ..'; }
            60% { content: ' ...'; }
            80%, 100% { content: ''; }
        }

        /* ПОЛНОЕ СКРЫТИЕ ВЕЗДЕ */
        *::-webkit-scrollbar {
            display: none;
        }
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        /* Скрытие стандартной стрелочки у details (Safari/Webkit) */
        summary::-webkit-details-marker {
            display: none;
        }

        html, body {
            overscroll-behavior-y: auto; 
            height: 100%;
            position: fixed;
            width: 100%;
            overflow: hidden;
        }

        @keyframes shimmer {
            0% { transform: translateX(-150%) skewX(-12deg); }
            100% { transform: translateX(250%) skewX(-12deg); }
        }

        main, .overflow-y-auto {
            overflow-y: scroll; 
            overscroll-behavior-y: auto; 
            -webkit-overflow-scrolling: touch; 
        }
        
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        .modal-backdrop {
            background-color: rgba(28, 25, 23, 0.4);
            backdrop-filter: blur(4px);
        }
        .dark .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
        }
        
        .chart-bar {
            height: 0;
            transition: height 1s ease-out;
        }

        /* Стили для чекбоксов */
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            background-color: #fff;
            margin: 0;
            font: inherit;
            color: #444; 
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #e7e5e4; 
            border-radius: 0.5rem; 
            display: grid;
            place-content: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        
        .dark input[type="checkbox"] {
            background-color: #302d2b;
            border-color: #3d3936;
        }

        input[type="checkbox"]::before {
            content: "";
            width: 0.65rem;
            height: 0.65rem;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em #fff; 
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        
        .dark input[type="checkbox"]::before {
            box-shadow: inset 1em 1em #fff;
        }

        input[type="checkbox"]:checked {
            background-color: var(--brand-main);
            border-color: var(--brand-main);
        }

        input[type="checkbox"]:checked::before {
            transform: scale(1);
        }

        input[type="checkbox"]:focus {
            outline: 2px solid rgba(214, 211, 209, 0.5); 
            outline-offset: 2px;
        }

        .dark input[type="checkbox"]:focus {
            outline: 2px solid rgba(168, 162, 158, 0.3);
        }

        /* Auth Specific Styles */
        .auth-input {
            transition: all 0.2s;
        }
        .auth-input:focus {
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="text-stone-800 bg-[#fafaf9] dark:text-stone-100 dark:bg-warm-base h-screen w-screen flex overflow-hidden transition-colors duration-300">

    <!-- AUTH CONTAINER (Visible initially) -->
    <div id="auth-container" class="fixed inset-0 z-50 bg-[#fafaf9] dark:bg-warm-base flex items-center justify-center p-4 transition-colors duration-300">
        <div class="w-full max-w-md bg-white dark:bg-warm-surface rounded-[2.5rem] shadow-xl dark:shadow-none dark:border dark:border-warm-border p-8 md:p-10 fade-in transition-colors duration-300">
            <div class="text-center mb-8">
                <span class="font-bold text-2xl tracking-tight text-stone-800 dark:text-white">Interview<span class="text-brand-main">AI</span></span>
                <p class="text-stone-400 dark:text-stone-500 text-sm mt-2 font-medium" id="auth-subtitle">Войдите, чтобы продолжить обучение</p>
            </div>

            <!-- Login Form -->
            <form id="login-form" onsubmit="app.handleLogin(event)" class="space-y-5 block">
                <div>
                    <label class="block text-xs font-bold text-stone-500 dark:text-stone-400 uppercase tracking-wider mb-2 ml-1">Email</label>
                    <input type="email" id="login-email" required class="auth-input w-full p-4 bg-stone-50 dark:bg-warm-alt border border-stone-200 dark:border-warm-border rounded-2xl focus:bg-white dark:focus:bg-warm-surface focus:ring-2 focus:ring-brand-main/50 outline-none transition font-medium text-stone-800 dark:text-white placeholder-stone-400 dark:placeholder-stone-500" placeholder="hello@example.com">
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 dark:text-stone-400 uppercase tracking-wider mb-2 ml-1">Пароль</label>
                    <input type="password" id="login-password" required class="auth-input w-full p-4 bg-stone-50 dark:bg-warm-alt border border-stone-200 dark:border-warm-border rounded-2xl focus:bg-white dark:focus:bg-warm-surface focus:ring-2 focus:ring-brand-main/50 outline-none transition font-medium text-stone-800 dark:text-white placeholder-stone-400 dark:placeholder-stone-500" placeholder="••••••••">
                </div>
                
                <div id="login-error" class="hidden text-rose-500 dark:text-rose-400 text-sm text-center font-medium bg-rose-50 dark:bg-rose-500/10 p-3 rounded-xl border border-rose-100 dark:border-rose-500/20"></div>

                <button type="submit" id="login-btn" class="w-full bg-brand-main text-white py-4 rounded-2xl hover:bg-brand-hover transition shadow-lg shadow-brand-main/25 dark:shadow-none font-bold text-sm flex items-center justify-center gap-2">
                    <span>Войти</span>
                    <i class="ph-bold ph-arrow-right"></i>
                </button>

                <div class="text-center mt-6">
                    <button type="button" onclick="app.toggleAuthMode('register')" class="text-stone-500 dark:text-stone-400 text-sm hover:text-stone-800 dark:hover:text-white font-medium transition">
                        Нет аккаунта? <span class="text-stone-800 dark:text-stone-200 underline decoration-stone-200 dark:decoration-warm-border underline-offset-4">Регистрация</span>
                    </button>
                </div>
            </form>

            <!-- Register Form (Hidden) -->
            <form id="register-form" onsubmit="app.handleRegister(event)" class="space-y-5 hidden">
                <div>
                    <label class="block text-xs font-bold text-stone-500 dark:text-stone-400 uppercase tracking-wider mb-2 ml-1">Email</label>
                    <input type="email" id="reg-email" required class="auth-input w-full p-4 bg-stone-50 dark:bg-warm-alt border border-stone-200 dark:border-warm-border rounded-2xl focus:bg-white dark:focus:bg-warm-surface focus:ring-2 focus:ring-brand-main/50 outline-none transition font-medium text-stone-800 dark:text-white placeholder-stone-400 dark:placeholder-stone-500" placeholder="Ваш email">
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 dark:text-stone-400 uppercase tracking-wider mb-2 ml-1">Пароль</label>
                    <input type="password" id="reg-password" required minlength="6" class="auth-input w-full p-4 bg-stone-50 dark:bg-warm-alt border border-stone-200 dark:border-warm-border rounded-2xl focus:bg-white dark:focus:bg-warm-surface focus:ring-2 focus:ring-brand-main/50 outline-none transition font-medium text-stone-800 dark:text-white placeholder-stone-400 dark:placeholder-stone-500" placeholder="Минимум 6 символов">
                </div>
                <div>
                    <label class="block text-xs font-bold text-stone-500 dark:text-stone-400 uppercase tracking-wider mb-2 ml-1">Повторите пароль</label>
                    <input type="password" id="reg-password-confirm" required minlength="6" class="auth-input w-full p-4 bg-stone-50 dark:bg-warm-alt border border-stone-200 dark:border-warm-border rounded-2xl focus:bg-white dark:focus:bg-warm-surface focus:ring-2 focus:ring-brand-main/50 outline-none transition font-medium text-stone-800 dark:text-white placeholder-stone-400 dark:placeholder-stone-500" placeholder="••••••••">
                </div>

                <div id="reg-error" class="hidden text-rose-500 dark:text-rose-400 text-sm text-center font-medium bg-rose-50 dark:bg-rose-500/10 p-3 rounded-xl border border-rose-100 dark:border-rose-500/20"></div>

                <button type="submit" id="reg-btn" class="w-full bg-brand-main text-white py-4 rounded-2xl hover:bg-brand-hover transition shadow-lg shadow-brand-main/25 dark:shadow-none font-bold text-sm flex items-center justify-center gap-2">
                    <span>Создать аккаунт</span>
                    <i class="ph-bold ph-user-plus"></i>
                </button>

                <div class="text-center mt-6">
                    <button type="button" onclick="app.toggleAuthMode('login')" class="text-stone-500 dark:text-stone-400 text-sm hover:text-stone-800 dark:hover:text-white font-medium transition">
                        Уже есть аккаунт? <span class="text-stone-800 dark:text-stone-200 underline decoration-stone-200 dark:decoration-warm-border underline-offset-4">Войти</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MAIN APP CONTAINER (Hidden initially) -->
    <div id="app-container" class="hidden flex-1 flex h-full relative min-w-0 bg-[#fafaf9] dark:bg-warm-base w-full transition-colors duration-300">
        
        <aside class="hidden md:flex w-72 bg-white dark:bg-warm-surface border-r border-stone-200 dark:border-warm-border flex-col z-20 shadow-[4px_0_24px_rgba(0,0,0,0.02)] dark:shadow-none flex-shrink-0 transition-colors duration-300">
            <div class="h-20 flex items-center px-8 border-b border-stone-50 dark:border-warm-border justify-center mt-14">
                <span class="font-bold text-xl tracking-tight text-stone-800 dark:text-white">Interview<span class="text-brand-main">AI</span></span>
            </div>
            
            <nav class="flex-1 p-6 space-y-2 overflow-y-auto flex flex-col justify-center -mt-20">
                <button onclick="app.navigate('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-4 px-4 py-3.5 rounded-xl text-stone-500 dark:text-stone-400 hover:bg-stone-50 dark:hover:bg-warm-alt hover:text-stone-900 dark:hover:text-white transition-all font-semibold text-left group">
                    <i class="ph ph-chart-pie-slice text-xl group-hover:scale-110 transition-transform"></i> Обзор
                </button>
                <button onclick="app.navigate('cards')" id="nav-cards" class="nav-item w-full flex items-center gap-4 px-4 py-3.5 rounded-xl text-stone-500 dark:text-stone-400 hover:bg-stone-50 dark:hover:bg-warm-alt hover:text-stone-900 dark:hover:text-white transition-all font-semibold text-left group">
                    <i class="ph ph-cards text-xl group-hover:scale-110 transition-transform"></i> Карточки
                </button>
                <button onclick="app.navigate('study')" id="nav-study" class="nav-item w-full flex items-center gap-4 px-4 py-3.5 rounded-xl text-stone-500 dark:text-stone-400 hover:bg-stone-50 dark:hover:bg-warm-alt hover:text-stone-900 dark:hover:text-white transition-all font-semibold text-left group">
                    <i class="ph ph-student text-xl group-hover:scale-110 transition-transform"></i> Тренировка
                </button>
                <button onclick="app.navigate('settings')" id="nav-settings" class="nav-item w-full flex items-center gap-4 px-4 py-3.5 rounded-xl text-stone-500 dark:text-stone-400 hover:bg-stone-50 dark:hover:bg-warm-alt hover:text-stone-900 dark:hover:text-white transition-all font-semibold text-left group">
                    <i class="ph ph-sliders-horizontal text-xl group-hover:scale-110 transition-transform"></i> Настройки
                </button>
            </nav>

            <div class="p-6 border-t border-stone-50 dark:border-warm-border">
                <button onclick="app.handleLogout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-stone-400 dark:text-stone-500 hover:text-rose-500 dark:hover:text-rose-400 hover:bg-rose-50 dark:hover:bg-rose-500/10 transition-all font-semibold text-sm">
                    <i class="ph-bold ph-sign-out text-lg"></i> Выйти
                </button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col h-full relative min-w-0 bg-[#fafaf9] dark:bg-warm-base w-full transition-colors duration-300">
            
            <header class="md:hidden fixed top-0 left-0 right-0 h-14 bg-[#fafaf9] dark:bg-warm-base flex items-center justify-center z-50 border-b border-stone-200 dark:border-warm-border transition-colors duration-300">
                 <span class="font-bold text-xl tracking-tight text-stone-700 dark:text-stone-200">interview<span class="text-brand-main">ai</span></span>
            </header>
    
            <main class="flex-1 overflow-y-auto p-0 md:px-10 md:pb-10 md:pt-0 scroll-smooth pb-24 md:pb-10 w-full" id="main-container">
                <div class="h-full flex flex-col items-center justify-center">
                    <i class="ph-light ph-spinner animate-spin text-4xl text-stone-400 dark:text-stone-500 mb-4"></i>
                    <span class="text-stone-400 dark:text-stone-500 text-sm">Загрузка базы знаний...</span>
                </div>
            </main>
    
            <nav class="md:hidden fixed custom-bottom-nav bottom-0 left-0 right-0 bg-white/90 dark:bg-warm-surface/90 backdrop-blur-xl border-t border-stone-200/50 dark:border-warm-border/50 flex justify-around p-2 z-40 pb-safe shadow-lg dark:shadow-none transition-colors duration-300">
                 <button onclick="app.navigate('dashboard')" class="mob-nav-item flex flex-col items-center p-2 rounded-xl w-16 transition-colors text-stone-400 dark:text-stone-500" id="mob-nav-dashboard">
                    <i class="ph ph-chart-pie-slice text-2xl mb-0.5"></i>
                    <span class="text-[10px] font-medium">Обзор</span>
                 </button>
                 <button onclick="app.navigate('cards')" class="mob-nav-item flex flex-col items-center p-2 rounded-xl w-16 transition-colors text-stone-400 dark:text-stone-500" id="mob-nav-cards">
                    <i class="ph ph-cards text-2xl mb-0.5"></i>
                    <span class="text-[10px] font-medium">Карточки</span>
                 </button>
                 <button onclick="app.navigate('study')" class="mob-nav-item flex flex-col items-center p-2 rounded-xl w-16 transition-colors text-stone-400 dark:text-stone-500" id="mob-nav-study">
                    <i class="ph ph-student text-2xl mb-0.5"></i>
                    <span class="text-[10px] font-medium">Тренировка</span>
                 </button>
                 <button onclick="app.navigate('settings')" class="mob-nav-item flex flex-col items-center p-2 rounded-xl w-16 transition-colors text-stone-400 dark:text-stone-500" id="mob-nav-settings">
                    <i class="ph ph-sliders-horizontal text-2xl mb-0.5"></i>
                    <span class="text-[10px] font-medium">Настройки</span>
                 </button>
            </nav>
        </div>
    </div>

    <!-- Modals (Shared) -->
    <div id="add-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 modal-backdrop transition-opacity opacity-0" id="modal-backdrop" onclick="app.closeAddModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90vw] max-w-lg bg-white dark:bg-warm-surface rounded-3xl shadow-2xl dark:shadow-none dark:border dark:border-warm-border p-6 md:p-8 transform scale-95 opacity-0 transition-all duration-300" id="modal-card">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-xl font-bold text-stone-800 dark:text-white">Новый вопрос</h2>
                <button onclick="app.closeAddModal()" class="w-8 h-8 rounded-full bg-stone-50 dark:bg-warm-alt text-stone-500 dark:text-stone-400 hover:bg-stone-100 dark:hover:bg-warm-border flex items-center justify-center transition">
                    <i class="ph-light ph-x text-lg"></i>
                </button>
            </div>
            <form id="add-form" onsubmit="app.saveCard(event)" class="space-y-5">
                <div>
                    <label class="block text-sm font-semibold text-stone-700 dark:text-stone-300 mb-1.5">Вопрос / Термин</label>
                    <textarea id="q-input" rows="2" class="w-full p-4 bg-stone-50 dark:bg-warm-alt border border-stone-200 dark:border-warm-border rounded-2xl focus:bg-white dark:focus:bg-warm-surface focus:ring-2 focus:ring-brand-main/50 outline-none transition font-medium text-stone-800 dark:text-white resize-none text-base placeholder-stone-400 dark:placeholder-stone-500" placeholder="Введите вопрос..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-stone-700 dark:text-stone-300 mb-1.5">Ответ / Определение</label>
                    <textarea id="a-input" rows="5" class="w-full p-4 bg-stone-50 dark:bg-warm-alt border border-stone-200 dark:border-warm-border rounded-2xl focus:bg-white dark:focus:bg-warm-surface focus:ring-2 focus:ring-brand-main/50 outline-none transition text-stone-600 dark:text-stone-300 text-base leading-relaxed placeholder-stone-400 dark:placeholder-stone-500" placeholder="Введите ответ..."></textarea>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-stone-700 dark:text-stone-300 mb-1.5">Список / Тема</label>
                    <select id="list-input" class="w-full p-4 bg-stone-50 dark:bg-warm-alt border border-stone-200 dark:border-warm-border rounded-2xl focus:bg-white dark:focus:bg-warm-surface outline-none transition text-base dark:text-white">
                        <option value="">Без списка</option>
                    </select>
                </div>
                <div class="flex items-center justify-end gap-3 pt-2">
                    <button id="modal-submit-btn" type="submit" class="w-full bg-brand-main text-white px-6 py-3.5 rounded-2xl hover:bg-brand-hover transition shadow-lg shadow-brand-main/25 dark:shadow-none font-bold flex items-center justify-center gap-2 text-sm">
                        <span id="modal-submit-text">Добавить</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="bulk-modal" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 modal-backdrop transition-opacity opacity-0" id="bulk-backdrop" onclick="app.closeBulkModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90vw] max-w-2xl bg-white dark:bg-warm-surface rounded-3xl shadow-2xl dark:shadow-none dark:border dark:border-warm-border p-6 md:p-8 transform scale-95 opacity-0 transition-all duration-300" id="bulk-card">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-stone-800 dark:text-white">Массовый импорт</h2>
                <button onclick="app.closeBulkModal()" class="w-8 h-8 rounded-full bg-stone-50 dark:bg-warm-alt text-stone-500 dark:text-stone-400 hover:bg-stone-100 dark:hover:bg-warm-border flex items-center justify-center transition">
                    <i class="ph-light ph-x text-lg"></i>
                </button>
            </div>
            <p class="text-xs text-stone-500 dark:text-stone-400 mb-4 leading-relaxed">
                Формат: <strong class="text-stone-700 dark:text-stone-200">Название списка | Вопрос | Ответ</strong><br>
                <span class="text-amber-600 dark:text-amber-500">Если списка нет, он создастся автоматически.</span>
            </p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-stone-700 dark:text-stone-300 mb-1.5">Разделитель (между вопросом и ответом)</label>
                    <input type="text" id="bulk-separator" value="|" class="w-20 p-2 bg-stone-50 dark:bg-warm-alt border border-stone-200 dark:border-warm-border rounded-xl text-center font-bold outline-none focus:ring-2 focus:ring-brand-main/50 dark:text-white">
                </div>
                <textarea id="bulk-input" rows="10" class="w-full p-4 bg-stone-50 dark:bg-warm-alt border border-stone-200 dark:border-warm-border rounded-2xl focus:bg-white dark:focus:bg-warm-surface focus:ring-2 focus:ring-brand-main/50 outline-none transition text-sm font-mono leading-relaxed resize-none dark:text-stone-300 placeholder-stone-400 dark:placeholder-stone-600" placeholder="JavaScript | Что такое замыкание? | Это функция + окружение&#10;React | Что такое JSX? | Расширение синтаксиса JS"></textarea>
                <button id="bulk-submit-btn" onclick="app.saveBulkCards()" class="w-full bg-brand-main text-white py-4 rounded-2xl hover:bg-brand-hover transition shadow-lg shadow-brand-main/25 dark:shadow-none font-bold flex items-center justify-center gap-2">
                    <span id="bulk-submit-text">Импортировать карточки</span>
                </button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 modal-backdrop transition-opacity opacity-0" id="confirm-backdrop" onclick="app.closeConfirmModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90vw] max-w-sm bg-white dark:bg-warm-surface rounded-[2.5rem] shadow-2xl dark:shadow-none dark:border dark:border-warm-border p-8 transform scale-95 opacity-0 transition-all duration-300" id="confirm-card">
            <div class="text-center">
                <div id="confirm-icon-bg" class="w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6">
                    <i id="confirm-icon" class="ph-fill text-4xl"></i>
                </div>
                <h2 id="confirm-title" class="text-xl font-bold text-stone-800 dark:text-white mb-2">Вы уверены?</h2>
                <p id="confirm-desc" class="text-stone-500 dark:text-stone-400 text-sm mb-8 leading-relaxed px-2"></p>
                
                <div class="flex flex-col gap-3">
                    <button id="confirm-action-btn" onclick="app.executeConfirmedAction()" class="w-full py-4 rounded-2xl font-bold text-white shadow-lg dark:shadow-none transition-all active:scale-95">
                        Подтвердить
                    </button>
                    <button onclick="app.closeConfirmModal()" class="w-full py-4 rounded-2xl font-bold text-stone-400 hover:bg-stone-50 dark:hover:bg-warm-alt transition-all">
                        Отмена
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="list-modal" class="fixed inset-0 z-[65] hidden">
        <div class="absolute inset-0 modal-backdrop transition-opacity opacity-0" id="list-backdrop" onclick="app.closeListModal()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90vw] max-w-sm bg-white dark:bg-warm-surface rounded-[2.5rem] shadow-2xl dark:shadow-none dark:border dark:border-warm-border p-8 transform scale-95 opacity-0 transition-all duration-300" id="list-card">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-stone-800 dark:text-white">Новый список</h2>
                <button onclick="app.closeListModal()" class="w-8 h-8 rounded-full bg-stone-50 dark:bg-warm-alt text-stone-500 dark:text-stone-400 flex items-center justify-center transition hover:bg-stone-100 dark:hover:bg-warm-border">
                    <i class="ph-light ph-x"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-semibold text-stone-700 dark:text-stone-300 mb-2">Название темы</label>
                    <input type="text" id="list-name-input" 
                        class="w-full p-4 bg-stone-50 dark:bg-warm-alt border border-stone-200 dark:border-warm-border rounded-2xl focus:bg-white dark:focus:bg-warm-surface focus:ring-2 focus:ring-brand-main/50 outline-none transition font-medium text-stone-800 dark:text-white placeholder-stone-400 dark:placeholder-stone-500" 
                        placeholder="Например: JavaScript, React...">
                </div>
                
                <button id="list-submit-btn" onclick="app.saveList()" class="w-full bg-brand-main text-white py-4 rounded-2xl hover:bg-brand-hover transition shadow-lg shadow-brand-main/25 dark:shadow-none font-bold flex items-center justify-center gap-2">
                    <span id="list-submit-text">Создать список</span>
                </button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-stone-800 dark:bg-white text-white dark:text-stone-900 px-6 py-3 rounded-full shadow-2xl transition-all duration-300 z-[70] opacity-0 pointer-events-none translate-y-[-20px] flex items-center gap-3 font-medium text-sm w-max max-w-[90vw] backdrop-blur-md bg-stone-800/90 dark:bg-white/90">
        <i class="ph-light ph-info text-amber-400 dark:text-amber-500 text-lg"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCVMFrHhfWDEcsUqt1XuHyv74cagyBTIbc",
            authDomain: "memocards-796c6.firebaseapp.com",
            projectId: "memocards-796c6",
            storageBucket: "memocards-796c6.firebasestorage.app",
            messagingSenderId: "732064067940",
            appId: "1:732064067940:web:bdd243ffb8bd975e19ca71"
        };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'interview-prep-ai-v1';
        
        const firebaseApp = initializeApp(firebaseConfig);
        const auth = getAuth(firebaseApp);
        const db = getFirestore(firebaseApp);

        // --- XSS PROTECTION HELPER ---
        const escapeHtml = (unsafe) => {
            if (!unsafe) return "";
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        };

        const saveSession = () => {
            const session = {
                queueIds: window.appState.studyQueue.map(c => c.id),
                index: window.appState.currentCardIndex
            };
            localStorage.setItem('study_session', JSON.stringify(session));
        };

        const clearSession = () => {
            localStorage.removeItem('study_session');
        };

        // Initialize Base State
        window.appState = {
            user: null,
            cards: [],
            currentView: 'dashboard',
            studyQueue: [],
            currentCardIndex: 0,
            groqKey: localStorage.getItem('groq_api_key') || '',
            stats: { total: 0, learned: 0, accuracy: 0, chartData: [] },
            isProcessing: false,
            editingId: null,
            searchTerm: '',
            chartPeriod: 7,
            isShowingFeedback: false,
            isDataLoaded: false,
            lists: [],
            activeListId: 'all',
            theme: localStorage.getItem('app_theme') || 'emerald',
            colorMode: localStorage.getItem('app_color_mode') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
        };

        // Initialize Theme Color Before Render
        document.documentElement.setAttribute('data-theme', window.appState.theme);

        // --- AUTH INITIALIZATION ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (e) {
                    console.error("Custom token login failed", e);
                }
            }
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            const authContainer = document.getElementById('auth-container');
            const appContainer = document.getElementById('app-container');

            if (user) {
                window.appState.user = user;
                authContainer.classList.add('hidden');
                appContainer.classList.remove('hidden');

                const qCards = query(collection(db, 'artifacts', appId, 'users', user.uid, 'cards'));
                onSnapshot(qCards, (snapshot) => {
                    const cards = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    cards.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    window.appState.cards = cards;
                    window.appState.isDataLoaded = true; 
                    updateStats();
                    if(window.appState.currentView !== 'study') render();
                });

                const qLists = query(collection(db, 'artifacts', appId, 'users', user.uid, 'lists'));
                onSnapshot(qLists, (snapshot) => {
                    const lists = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    lists.sort((a, b) => a.name.localeCompare(b.name));
                    window.appState.lists = lists;
                    if(window.appState.currentView !== 'study') render();
                });

                render();
            } else {
                window.appState.user = null;
                window.appState.cards = [];
                window.appState.lists = [];
                
                appContainer.classList.add('hidden');
                authContainer.classList.remove('hidden');
                
                document.getElementById('login-form').reset();
                document.getElementById('register-form').reset();
            }
        });

        // --- RENDERING HELPERS ---
        function renderResumeChoice(container) {
            container.innerHTML = `
                <div class="max-w-md mx-auto fade-in h-full flex flex-col justify-center px-6">
                    <div class="bg-white dark:bg-warm-surface rounded-[2.5rem] shadow-xl dark:shadow-none p-8 text-center border border-stone-100 dark:border-warm-border">
                        <div class="w-20 h-20 bg-amber-50 dark:bg-amber-500/10 text-amber-600 dark:text-amber-500 rounded-3xl flex items-center justify-center mx-auto mb-6">
                            <i class="ph-fill ph-ClockCounterClockwise text-4xl"></i>
                        </div>
                        <h2 class="text-2xl font-bold text-stone-800 dark:text-white mb-2">Продолжить?</h2>
                        <p class="text-stone-500 dark:text-stone-400 mb-8 leading-relaxed">У вас есть незавершенная тренировка. Хотите вернуться к ней или начать новую сессию?</p>
                        
                        <div class="flex flex-col gap-3">
                            <button onclick="app.resumeSession()" class="w-full py-4 bg-brand-main text-white rounded-2xl font-bold shadow-lg shadow-brand-main/25 dark:shadow-none hover:bg-brand-hover transition-all active:scale-95">
                                Продолжить текущую
                            </button>
                            <button onclick="app.restartSession()" class="w-full py-4 bg-stone-100 dark:bg-warm-alt text-stone-600 dark:text-stone-300 rounded-2xl font-bold hover:bg-stone-200 dark:hover:bg-warm-border transition-all">
                                Начать заново
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderLobby(container) {
            const stats = window.appState.cards.reduce((acc, c) => {
                if ((c.attempts || 0) === 0) acc.new++;
                if ((c.incorrect || 0) > 0) acc.mistakes++;
                if ((c.correct || 0) > 2) acc.learned++;
                return acc;
            }, { new: 0, mistakes: 0, learned: 0 });

            const listCounts = window.appState.cards.reduce((acc, c) => {
                if (c.listId) {
                    acc[c.listId] = (acc[c.listId] || 0) + 1;
                }
                return acc;
            }, {});

            const activeLists = window.appState.lists.filter(list => (listCounts[list.id] || 0) > 0);

            container.innerHTML = `
                <div class="max-w-md mx-auto fade-in pb-0 pt-14 md:pt-10 px-4 min-h-[101%]">
                    <h1 class="text-2xl font-bold text-stone-800 dark:text-white mb-6 px-2 mt-6">Тренировка</h1>
                    <div class="grid grid-cols-1 gap-4">
                        
                        <button onclick="app.startStudy('new')" class="flex items-center gap-4 p-4 bg-white dark:bg-warm-surface rounded-3xl border border-stone-100 dark:border-warm-border shadow-sm dark:shadow-none hover:border-brand-main/30 dark:hover:border-brand-main/50 transition-all text-left group">
                            <div class="w-12 h-12 bg-brand-light dark:bg-brand-main/10 text-brand-main rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform"><i class="ph-fill ph-sparkle text-2xl"></i></div>
                            <div class="flex-1">
                                <div class="font-bold text-stone-800 dark:text-white">Новые</div>
                                <div class="text-xs text-stone-400 dark:text-stone-500">В очереди: ${stats.new}</div>
                            </div>
                        </button>

                        <button onclick="app.startStudy('mistakes')" class="flex items-center gap-4 p-4 bg-white dark:bg-warm-surface rounded-3xl border border-stone-100 dark:border-warm-border shadow-sm dark:shadow-none hover:border-rose-200 dark:hover:border-rose-500/50 transition-all text-left group">
                            <div class="w-12 h-12 bg-rose-50 dark:bg-rose-500/10 text-rose-500 dark:text-rose-400 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform"><i class="ph-fill ph-warning-circle text-2xl"></i></div>
                            <div class="flex-1">
                                <div class="font-bold text-stone-800 dark:text-white">Ошибки</div>
                                <div class="text-xs text-stone-400 dark:text-stone-500">Нужно повторить: ${stats.mistakes}</div>
                            </div>
                        </button>

                        <button onclick="app.startStudy('all')" class="flex items-center gap-4 p-4 bg-white dark:bg-warm-surface rounded-3xl border border-stone-100 dark:border-warm-border shadow-sm dark:shadow-none hover:border-amber-200 dark:hover:border-amber-500/50 transition-all text-left group">
                            <div class="w-12 h-12 bg-amber-50 dark:bg-amber-500/10 text-amber-500 dark:text-amber-400 rounded-2xl flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="ph-fill ph-infinity text-2xl"></i>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-stone-800 dark:text-white">Повторить все</div>
                                <div class="text-xs text-stone-400 dark:text-stone-500">Все карточки: ${window.appState.cards.length}</div>
                            </div>
                        </button>

                        ${activeLists.length > 0 ? `
                        <div class="mt-4">
                            <div class="flex items-center justify-between mb-3 px-2">
                                <h3 class="text-xs font-bold text-stone-400 dark:text-stone-500 uppercase tracking-wider">Выбор тем</h3>
                                <button onclick="document.querySelectorAll('input[name=\\'study-list\\']').forEach(el => el.checked = true)" class="text-[10px] font-bold text-stone-400 dark:text-stone-500 hover:text-stone-800 dark:hover:text-white transition">Выбрать все</button>
                            </div>
                            
                            <div class="bg-white dark:bg-warm-surface rounded-[2rem] shadow-sm dark:shadow-none border border-stone-100 dark:border-warm-border p-2 space-y-1">
                            ${activeLists.map(list => {
                                const count = listCounts[list.id];
                                return `
                                <label class="flex items-center gap-3 p-3 hover:bg-stone-50 dark:hover:bg-warm-alt rounded-2xl cursor-pointer transition-colors group select-none">
                                    <input type="checkbox" name="study-list" value="${list.id}">
                                    <div class="flex-1">
                                        <div class="font-bold text-stone-700 dark:text-stone-300 text-sm group-hover:text-stone-900 dark:group-hover:text-white">${escapeHtml(list.name)}</div>
                                        <div class="text-[10px] text-stone-400 dark:text-stone-500 font-medium">${count} шт.</div>
                                    </div>
                                </label>
                                `;
                            }).join('')}
                            </div>

                            <button onclick="app.startMultiListStudy()" class="w-full mt-4 bg-brand-main text-white py-4 rounded-2xl hover:bg-brand-hover transition shadow-lg shadow-brand-main/25 dark:shadow-none font-bold text-sm flex items-center justify-center gap-2">
                                <span>Начать выбранные</span>
                                <i class="ph-bold ph-play-circle text-lg"></i>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function updateStats() {
            const cards = window.appState.cards;
            const total = cards.length;
            const attempts = cards.reduce((acc, c) => acc + (c.attempts || 0), 0);
            const correct = cards.reduce((acc, c) => acc + (c.correct || 0), 0);
            
            const period = window.appState.chartPeriod || 7;
            const chartData = [];
            const now = new Date();
            
            for (let i = period - 1; i >= 0; i--) {
                const d = new Date(now);
                d.setDate(d.getDate() - i);
                const dayStart = new Date(d.setHours(0,0,0,0)).getTime() / 1000;
                const dayEnd = new Date(d.setHours(23,59,59,999)).getTime() / 1000;
                
                const reviewedThatDay = cards.filter(c => {
                    if(!c.lastReviewed) return false;
                    const t = c.lastReviewed.seconds;
                    return t >= dayStart && t <= dayEnd;
                });

                const learnedCount = reviewedThatDay.filter(c => (c.correct || 0) > 2).length;
                const repeatedCount = reviewedThatDay.length - learnedCount;

                chartData.push({ 
                    day: d.getDate(), 
                    learnedCount: learnedCount, 
                    repeatedCount: repeatedCount,
                    totalCount: reviewedThatDay.length 
                });
            }

            window.appState.stats = {
                total,
                learned: cards.filter(c => (c.correct || 0) > 2).length,
                accuracy: attempts === 0 ? 0 : Math.round((correct / attempts) * 100),
                chartData
            };
        }

        function getFirebaseErrorMessage(code) {
            switch(code) {
                case 'auth/invalid-email': return 'Некорректный email';
                case 'auth/user-disabled': return 'Пользователь заблокирован';
                case 'auth/user-not-found': return 'Пользователь не найден';
                case 'auth/wrong-password': return 'Неверный пароль';
                case 'auth/invalid-credential': return 'Неверные данные входа';
                case 'auth/email-already-in-use': return 'Email уже занят';
                case 'auth/weak-password': return 'Слабый пароль (минимум 6 символов)';
                case 'auth/too-many-requests': return 'Слишком много попыток. Подождите.';
                default: return 'Ошибка: ' + code;
            }
        }

        window.app = {

            resetCardProgress: (id) => {
                app.openConfirmModal('resetCard', id);
            },
            
            getThemeHex: (theme) => {
                const colors = {
                    emerald: '#059669',
                    blue: '#2563eb',
                    violet: '#7c3aed',
                    rose: '#e11d48',
                    amber: '#d97706'
                };
                return colors[theme] || colors.emerald;
            },

            setTheme: (themeName) => {
                window.appState.theme = themeName;
                localStorage.setItem('app_theme', themeName);
                document.documentElement.setAttribute('data-theme', themeName);
                render(); 
            },

            setColorMode: (mode) => {
                window.appState.colorMode = mode;
                localStorage.setItem('app_color_mode', mode);
                if (mode === 'dark') {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                render();
            },

            // --- AUTH METHODS ---
            toggleAuthMode: (mode) => {
                const loginForm = document.getElementById('login-form');
                const regForm = document.getElementById('register-form');
                const title = document.getElementById('auth-subtitle');
                
                document.getElementById('login-error').classList.add('hidden');
                document.getElementById('reg-error').classList.add('hidden');

                if (mode === 'register') {
                    loginForm.classList.add('hidden');
                    regForm.classList.remove('hidden');
                    regForm.classList.add('fade-in');
                    title.innerText = "Создайте аккаунт, чтобы начать";
                } else {
                    regForm.classList.add('hidden');
                    loginForm.classList.remove('hidden');
                    loginForm.classList.add('fade-in');
                    title.innerText = "Войдите, чтобы продолжить обучение";
                }
            },

            handleLogin: async (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const pass = document.getElementById('login-password').value;
                const btn = document.getElementById('login-btn');
                const errDiv = document.getElementById('login-error');

                btn.disabled = true;
                btn.innerHTML = `<i class="ph-bold ph-spinner animate-spin text-lg"></i>`;
                errDiv.classList.add('hidden');

                try {
                    await signInWithEmailAndPassword(auth, email, pass);
                } catch (error) {
                    errDiv.innerText = getFirebaseErrorMessage(error.code);
                    errDiv.classList.remove('hidden');
                    btn.disabled = false;
                    btn.innerHTML = `<span>Войти</span><i class="ph-bold ph-arrow-right"></i>`;
                }
            },

            handleRegister: async (e) => {
                e.preventDefault();
                const email = document.getElementById('reg-email').value;
                const pass = document.getElementById('reg-password').value;
                const passConfirm = document.getElementById('reg-password-confirm').value;
                const btn = document.getElementById('reg-btn');
                const errDiv = document.getElementById('reg-error');

                if (pass !== passConfirm) {
                    errDiv.innerText = "Пароли не совпадают";
                    errDiv.classList.remove('hidden');
                    return;
                }

                btn.disabled = true;
                btn.innerHTML = `<i class="ph-bold ph-spinner animate-spin text-lg"></i>`;
                errDiv.classList.add('hidden');

                try {
                    await createUserWithEmailAndPassword(auth, email, pass);
                } catch (error) {
                    errDiv.innerText = getFirebaseErrorMessage(error.code);
                    errDiv.classList.remove('hidden');
                    btn.disabled = false;
                    btn.innerHTML = `<span>Создать аккаунт</span><i class="ph-bold ph-user-plus"></i>`;
                }
            },

            handleLogout: async () => {
                app.openConfirmModal('logout');
            },

            // --- APP LOGIC ---
            navigate: (view) => {
                window.appState.isShowingFeedback = false;
                
                window.appState.currentView = view;
                window.appState.isProcessing = false;

                if (view === 'study') {
                    const saved = localStorage.getItem('study_session');
                    if (window.appState.studyQueue.length === 0 && saved) {
                        window.appState.showResumeChoice = true;
                    }
                } else {
                    window.appState.showResumeChoice = false;
                }
                
                render(); 
            },
            
            setSearchTerm: (term) => {
                window.appState.searchTerm = term.toLowerCase();
                
                const listContainer = document.getElementById('cards-list-container');
                
                if (listContainer) {
                    listContainer.innerHTML = renderCardsItemsHTML();
                } else {
                    render();
                }
            },

            exitStudy: () => {
                window.appState.studyQueue = []; 
                window.appState.currentCardIndex = 0;
                clearSession(); 
                render(); 
            },

            pendingAction: null,
            pendingListId: null,

            openConfirmModal: (type, listId = null) => {
                window.app.pendingAction = type;
                window.app.pendingListId = listId;
                
                const modal = document.getElementById('confirm-modal');
                const backdrop = document.getElementById('confirm-backdrop');
                const card = document.getElementById('confirm-card');
                const title = document.getElementById('confirm-title');
                const desc = document.getElementById('confirm-desc');
                const icon = document.getElementById('confirm-icon');
                const iconBg = document.getElementById('confirm-icon-bg');
                const btn = document.getElementById('confirm-action-btn');

                if (type === 'deleteList') {
                    const list = window.appState.lists.find(l => l.id === listId);
                    title.innerText = "Удалить список?";
                    desc.innerText = `Список «${list?.name}» будет удален. Карточки внутри него останутся, но потеряют категорию.`;
                    icon.className = "ph-fill ph-folder-minus text-rose-500 dark:text-rose-400 text-4xl";
                    iconBg.className = "w-20 h-20 bg-rose-50 dark:bg-rose-500/10 rounded-3xl flex items-center justify-center mx-auto mb-6";
                    btn.className = "w-full py-4 rounded-2xl font-bold text-white shadow-lg bg-rose-500 hover:bg-rose-600 shadow-rose-100 dark:shadow-none";
                    btn.innerText = "Удалить";
                }
                else if (type === 'delete') {
                    title.innerText = "Удалить всё?";
                    desc.innerText = "Это полностью очистит вашу базу карточек. Восстановить ихбудет невозможно.";
                    icon.className = "ph-fill ph-trash text-rose-500 dark:text-rose-400 text-4xl";
                    iconBg.className = "w-20 h-20 bg-rose-50 dark:bg-rose-500/10 rounded-3xl flex items-center justify-center mx-auto mb-6";
                    btn.className = "w-full py-4 rounded-2xl font-bold text-white shadow-lg bg-rose-500 hover:bg-rose-600 shadow-rose-100 dark:shadow-none";
                    btn.innerText = "Удалить всё";
                }
                else if (type === 'resetCard') {
                    const card = window.appState.cards.find(c => c.id === listId);
                    window.app.pendingCardId = listId; 
                    
                    title.innerText = "Сбросить прогресс?";
                    desc.innerText = `Статистика карточки «${card?.question}» будет обнулена.`;
                    icon.className = "ph-fill ph-arrows-counter-clockwise text-amber-500 dark:text-amber-400 text-4xl";
                    iconBg.className = "w-20 h-20 bg-amber-50 dark:bg-amber-500/10 rounded-3xl flex items-center justify-center mx-auto mb-6";
                    btn.className = "w-full py-4 rounded-2xl font-bold text-white shadow-lg bg-amber-500 hover:bg-amber-600 shadow-amber-100 dark:shadow-none transition-all active:scale-95";
                    btn.innerText = "Сбросить";
                }
                else if (type === 'deleteCard') {
                    const card = window.appState.cards.find(c => c.id === listId); 
                    window.app.pendingCardId = listId; 
                    
                    title.innerText = "Удалить карточку?";
                    desc.innerText = `Карточка «${card?.question}» будет удалена навсегда.`;
                    
                    icon.className = "ph-fill ph-trash-simple text-rose-500 dark:text-rose-400 text-4xl";
                    iconBg.className = "w-20 h-20 bg-rose-50 dark:bg-rose-500/10 rounded-3xl flex items-center justify-center mx-auto mb-6";
                    
                    btn.className = "w-full py-4 rounded-2xl font-bold text-white shadow-lg bg-rose-500 hover:bg-rose-600 shadow-rose-100 dark:shadow-none transition-all active:scale-95";
                    btn.innerText = "Удалить";
                }
                else if (type === 'reset') {
                    title.innerText = "Сбросить прогресс?";
                    desc.innerText = "Статистика изученных вопросов обнулится, но сами карточки останутся в базе.";
                    icon.className = "ph-fill ph-arrows-counter-clockwise text-amber-500 dark:text-amber-400 text-4xl";
                    iconBg.className = "w-20 h-20 bg-amber-50 dark:bg-amber-500/10 rounded-3xl flex items-center justify-center mx-auto mb-6";
                    btn.className = "w-full py-4 rounded-2xl font-bold text-white shadow-lg bg-amber-500 hover:bg-amber-600 shadow-amber-100 dark:shadow-none";
                    btn.innerText = "Сбросить";
                }
                else if (type === 'logout') {
                    title.innerText = "Выход из аккаунта";
                    desc.innerText = "Вы уверены, что хотите выйти из приложения?";
                    icon.className = "ph-fill ph-sign-out text-stone-600 dark:text-stone-300 text-4xl"; 
                    iconBg.className = "w-20 h-20 bg-stone-100 dark:bg-warm-alt rounded-3xl flex items-center justify-center mx-auto mb-6";
                    btn.className = "w-full py-4 rounded-2xl font-bold text-white shadow-lg bg-stone-800 dark:bg-stone-100 dark:text-stone-900 hover:bg-stone-900 dark:hover:bg-white shadow-stone-200 dark:shadow-none";
                    btn.innerText = "Выйти";
                }

                modal.classList.remove('hidden');
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    card.classList.remove('opacity-0', 'scale-95');
                }, 10);
            },

            closeConfirmModal: () => {
                const modal = document.getElementById('confirm-modal');
                const backdrop = document.getElementById('confirm-backdrop');
                const card = document.getElementById('confirm-card');
                backdrop.classList.add('opacity-0');
                card.classList.add('opacity-0', 'scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            },

            startStudy: (mode, listId = null) => {
                prepareStudySession(mode, listId);
                saveSession();
                render();
            },

            startMultiListStudy: () => {
                const checkedBoxes = document.querySelectorAll('input[name="study-list"]:checked');
                const selectedIds = Array.from(checkedBoxes).map(cb => cb.value);
                
                if (selectedIds.length === 0) {
                    showToast("Выберите хотя бы одну тему", true);
                    return;
                }
                
                app.startStudy('multi', selectedIds);
            },

            openListModal: () => {
                const modal = document.getElementById('list-modal');
                const backdrop = document.getElementById('list-backdrop');
                const card = document.getElementById('list-card');
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    card.classList.remove('opacity-0', 'scale-95');
                    document.getElementById('list-name-input').focus();
                }, 10);
            },

            closeListModal: () => {
                const modal = document.getElementById('list-modal');
                const backdrop = document.getElementById('list-backdrop');
                const card = document.getElementById('list-card');
                
                backdrop.classList.add('opacity-0');
                card.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.getElementById('list-name-input').value = '';
                }, 300);
            },

            saveList: async () => {
                const nameInput = document.getElementById('list-name-input');
                const name = nameInput.value.trim();
                const btn = document.getElementById('list-submit-btn');
                const btnText = document.getElementById('list-submit-text');

                if (!name) return showToast("Введите название", true);

                btn.disabled = true;
                btnText.innerHTML = `<i class="ph-bold ph-spinner animate-spin text-lg"></i>`;

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', window.appState.user.uid, 'lists'), {
                        name: name,
                        createdAt: serverTimestamp()
                    });
                    app.closeListModal();
                } catch (e) {
                    console.error(e);
                    showToast("Ошибка сохранения", true);
                } finally {
                    btn.disabled = false;
                    btnText.innerText = "Создать список";
                }
            },

            deleteList: async (listId) => {
                if (!confirm("Удалить список? Карточки останутся, но потеряют привязку.")) return;
                await deleteDoc(doc(db, 'artifacts', appId, 'users', window.appState.user.uid, 'lists', listId));
                window.appState.activeListId = 'all';
                render();
            },

            setActiveList: (id) => {
                window.appState.activeListId = id;

                render();

                const searchInput = document.querySelector('input[oninput*="setSearchTerm"]');
                if (searchInput && window.appState.searchTerm) {
                    searchInput.focus();
                    const val = searchInput.value;
                    searchInput.value = '';
                    searchInput.value = val;
                }
            },

            executeConfirmedAction: async () => {
                const type = window.app.pendingAction;
                const btn = document.getElementById('confirm-action-btn');
                
                btn.disabled = true;
                btn.innerHTML = `<i class="ph-bold ph-spinner animate-spin text-xl"></i>`;

                try {
                    const batch = writeBatch(db);

                    if (type === 'logout') {
                        await signOut(auth);
                    }

                    else if (type === 'deleteList') {
                        const listId = window.app.pendingListId;
                        if (!listId) throw new Error("ID списка не найден");

                        const listRef = doc(db, 'artifacts', appId, 'users', window.appState.user.uid, 'lists', listId);
                        batch.delete(listRef);

                        window.appState.cards.forEach(card => {
                            if (card.listId === listId) {
                                const cardRef = doc(db, 'artifacts', appId, 'users', window.appState.user.uid, 'cards', card.id);
                                batch.update(cardRef, { listId: "" });
                            }
                        });

                        await batch.commit();
                        window.appState.activeListId = 'all'; 
                    } 

                    else if (type === 'deleteCard') {
                        const cardId = window.app.pendingCardId;
                        if (cardId) {
                            const ref = doc(db, 'artifacts', appId, 'users', window.appState.user.uid, 'cards', cardId);
                            await deleteDoc(ref);
                            showToast("Карточка удалена");
                        }
                        
                    } else if (type === 'resetCard') {
                        const cardId = window.app.pendingCardId;
                        if (cardId) {
                            const ref = doc(db, 'artifacts', appId, 'users', window.appState.user.uid, 'cards', cardId);
                            await updateDoc(ref, {
                                attempts: 0,
                                correct: 0,
                                incorrect: 0,
                                skipped: 0,
                                lastReviewed: null
                            });
                            showToast("Прогресс карточки сброшен");
                        }
                    }

                    else if (type === 'delete' || type === 'reset') {
                        const cards = window.appState.cards;
                        
                        if (cards.length === 0) {
                            showToast("Карточек нет", true);
                        } else {
                            cards.forEach(card => {
                                const ref = doc(db, 'artifacts', appId, 'users', window.appState.user.uid, 'cards', card.id);
                                if (type === 'delete') {
                                    batch.delete(ref);
                                } else {
                                    batch.update(ref, { 
                                        attempts: 0, correct: 0, incorrect: 0, skipped: 0, lastReviewed: null 
                                    });
                                }
                            });
                            await batch.commit();
                        }
                    }
                    
                    app.closeConfirmModal();
                } catch (err) {
                    console.error("Action Error:", err);
                    showToast("Ошибка операции", true);
                } finally {
                    if(document.getElementById('confirm-action-btn')) {
                        btn.disabled = false;
                        btn.innerText = "Подтвердить";
                    }
                }
            },

            startFullReview: () => {
                prepareStudySession('all'); 
                saveSession(); 
                render();
            },

            setChartPeriod: (days) => {
                window.appState.chartPeriod = days;
                updateStats();
                render();
            },

            openBulkModal: () => {
                const modal = document.getElementById('bulk-modal');
                const backdrop = document.getElementById('bulk-backdrop');
                const card = document.getElementById('bulk-card');
                modal.classList.remove('hidden');
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    card.classList.remove('opacity-0', 'scale-95');
                }, 10);
            },

            closeBulkModal: () => {
                const modal = document.getElementById('bulk-modal');
                const backdrop = document.getElementById('bulk-backdrop');
                const card = document.getElementById('bulk-card');
                backdrop.classList.add('opacity-0');
                card.classList.add('opacity-0', 'scale-95');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.getElementById('bulk-input').value = '';
                }, 300);
            },

            saveBulkCards: async () => {
                const text = document.getElementById('bulk-input').value.trim();
                const separator = document.getElementById('bulk-separator').value || '|';
                const btn = document.getElementById('bulk-submit-btn');
                const btnText = document.getElementById('bulk-submit-text');

                if (!text) return showToast("Введите текст для импорта", true);

                const lines = text.split('\n').filter(line => line.split(separator).length >= 3);
                if (lines.length === 0) return showToast("Неверный формат (нужно: Список | Вопрос | Ответ)", true);

                btn.disabled = true;
                const originalText = btnText.innerText;
                btnText.innerHTML = `<i class="ph-light ph-spinner animate-spin text-lg"></i> Загрузка...`;

                try {
                    let count = 0;
                    const userUid = window.appState.user.uid;
                    
                    const localListsCache = [...window.appState.lists];

                    for (const line of lines) {
                        const parts = line.split(separator).map(p => p.trim());
                        if (parts.length < 3) continue;

                        const [listName, question, answer] = parts;
                        let listId = "";

                        if (listName) {
                            let existingList = localListsCache.find(l => l.name.toLowerCase() === listName.toLowerCase());

                            if (existingList) {
                                listId = existingList.id;
                            } else {
                                const listRef = await addDoc(collection(db, 'artifacts', appId, 'users', userUid, 'lists'), {
                                    name: listName,
                                    createdAt: serverTimestamp()
                                });
                                listId = listRef.id;
                                localListsCache.push({ id: listId, name: listName });
                            }
                        }

                        await addDoc(collection(db, 'artifacts', appId, 'users', userUid, 'cards'), {
                            question: question,
                            answer: answer,
                            listId: listId,
                            createdAt: serverTimestamp(),
                            attempts: 0,
                            correct: 0,
                            incorrect: 0,
                            skipped: 0,
                            lastReviewed: null
                        });
                        count++;
                    }

                    showToast(`Успешно добавлено ${count} карточек!`);
                    app.closeBulkModal();
                } catch (err) {
                    console.error(err);
                    showToast("Ошибка при импорте", true);
                } finally {
                    btn.disabled = false;
                    btnText.innerText = originalText;
                }
            },

            openAddModal: () => {
                window.appState.editingId = null;
                document.getElementById('modal-title').innerText = 'Новый вопрос';
                document.getElementById('modal-submit-text').innerText = 'Добавить';
                document.getElementById('add-form').reset();
                app.openModalUI();
            },

            resumeSession: () => {
                const saved = JSON.parse(localStorage.getItem('study_session'));
                const restoredQueue = saved.queueIds
                    .map(id => window.appState.cards.find(c => c.id === id))
                    .filter(Boolean); 

                window.appState.studyQueue = restoredQueue;
                window.appState.currentCardIndex = saved.index;
                window.appState.showResumeChoice = false;
                render();
            },

            restartSession: () => {
                clearSession();
                window.appState.showResumeChoice = false;
                prepareStudySession();
                saveSession();
                render();
            },

            openEditModal: (id) => {
                const card = window.appState.cards.find(c => c.id === id);
                if(!card) return;
                
                window.appState.editingId = id;
                document.getElementById('modal-title').innerText = 'Редактирование';
                document.getElementById('modal-submit-text').innerText = 'Сохранить';
                document.getElementById('q-input').value = card.question;
                document.getElementById('a-input').value = card.answer;
                
                app.openModalUI();
                
                document.getElementById('list-input').value = card.listId || "";
            },

            openModalUI: () => {
                const modal = document.getElementById('add-modal');
                const backdrop = document.getElementById('modal-backdrop');
                const card = document.getElementById('modal-card');
                
                const listSelect = document.getElementById('list-input');
                const currentLists = window.appState.lists || [];
                
                const currentValue = listSelect.value; 
                
                listSelect.innerHTML = `<option value="">Без списка</option>` + 
                    currentLists.map(l => `<option value="${l.id}">${escapeHtml(l.name)}</option>`).join('');
                
                if (currentValue) listSelect.value = currentValue;

                modal.classList.remove('hidden');
                setTimeout(() => {
                    backdrop.classList.remove('opacity-0');
                    card.classList.remove('opacity-0', 'scale-95');
                }, 10);
                document.getElementById('q-input').focus();
            },

            closeAddModal: () => {
                const modal = document.getElementById('add-modal');
                const backdrop = document.getElementById('modal-backdrop');
                const card = document.getElementById('modal-card');

                backdrop.classList.add('opacity-0');
                card.classList.add('opacity-0', 'scale-95');

                setTimeout(() => {
                    modal.classList.add('hidden');
                    document.getElementById('add-form').reset();
                    window.appState.editingId = null;
                }, 300);
            },
            
            saveCard: async (e) => {
                e.preventDefault();
                const q = document.getElementById('q-input').value.trim();
                const a = document.getElementById('a-input').value.trim();
                const listId = document.getElementById('list-input').value;
                
                if(!q || !a) return showToast("Заполните все поля", true);

                const btn = document.getElementById('modal-submit-btn');
                const btnText = document.getElementById('modal-submit-text');
                const originalText = btnText.innerText;
                
                btn.disabled = true;
                btnText.innerHTML = `<i class="ph-light ph-spinner animate-spin text-lg"></i>`;

                try {
                    if (window.appState.editingId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'users', window.appState.user.uid, 'cards', window.appState.editingId), {
                            question: q,
                            answer: a,
                            listId: listId,
                        });
                    } else {
                        await addDoc(collection(db, 'artifacts', appId, 'users', window.appState.user.uid, 'cards'), {
                            question: q,
                            answer: a,
                            createdAt: serverTimestamp(),
                            attempts: 0,
                            correct: 0,
                            incorrect: 0, 
                            skipped: 0,
                            lastReviewed: null,
                            listId: listId,
                        });
                    }
                    app.closeAddModal(); 
                } catch (err) {
                    console.error(err);
                    showToast("Ошибка сохранения", true);
                } finally {
                    btn.disabled = false;
                    btnText.innerText = originalText;
                }
            },

            deleteCard: (id) => {
                app.openConfirmModal('deleteCard', id);
            },

            saveSettings: () => {
                const key = document.getElementById('api-key-input').value.trim();
                localStorage.setItem('groq_api_key', key);
                window.appState.groqKey = key;
                app.navigate('dashboard');
            },
            
            submitAnswer: async () => {
                if (window.appState.isProcessing) return;
                
                const userAns = document.getElementById('study-input').value;
                if (!userAns.trim()) return showToast("Напишите ответ", true);

                const btn = document.getElementById('submit-btn');
                const btnText = document.getElementById('submit-btn-text');
                const cardElement = document.getElementById('study-card-main');

                try {
                    window.appState.isProcessing = true;
                    btn.disabled = true;
                    btnText.innerHTML = 'Анализ<span class="loading-dots"></span>';

                    const card = window.appState.studyQueue[window.appState.currentCardIndex];
                    const checkResult = await checkAnswerAI(userAns, card.answer);
                    const isCorrect = checkResult.isCorrect;

                    updateDoc(doc(db, 'artifacts', appId, 'users', window.appState.user.uid, 'cards', card.id), {
                        attempts: (card.attempts || 0) + 1,
                        correct: (card.correct || 0) + (isCorrect ? 1 : 0),
                        incorrect: (card.incorrect || 0) + (isCorrect ? 0 : 1), 
                        lastReviewed: serverTimestamp()
                    });

                    cardElement.classList.add('opacity-0', 'translate-y-4', 'transition-all', 'duration-300');
                    setTimeout(() => {
                        renderFeedbackView(checkResult, card.answer, userAns);
                    }, 300);

                } catch (error) {
                    console.error(error);
                    showToast("Ошибка связи", true);
                    btn.disabled = false;
                    btnText.innerText = 'Проверить';
                } finally {
                    window.appState.isProcessing = false;
                }
            },

            nextCard: () => {
                const cardElement = document.getElementById('study-card-main');
                cardElement.classList.add('card-exit-left');

                setTimeout(() => {
                    window.appState.isShowingFeedback = false;
                    window.appState.currentCardIndex++;
                    
                    if (window.appState.currentCardIndex >= window.appState.studyQueue.length) {
                        window.appState.studyQueue = []; 
                        window.appState.currentCardIndex = 0;
                        clearSession(); 
                        app.navigate('dashboard');
                    } else {
                        saveSession();
                        renderStudyCard();
                    }
                }, 350);
            },

            skipCard: async () => {
                const cardElement = document.getElementById('study-card-main');
                const card = window.appState.studyQueue[window.appState.currentCardIndex];
                
                cardElement.classList.add('card-exit-right');

                try {
                    updateDoc(doc(db, 'artifacts', appId, 'users', window.appState.user.uid, 'cards', card.id), {
                        skipped: (card.skipped || 0) + 1
                    });
                } catch (err) {}

                setTimeout(() => {
                    window.appState.isShowingFeedback = false; 
                    app.nextCardLogicOnly();
                }, 350);
            },

            nextCardLogicOnly: () => {
                window.appState.currentCardIndex++;
                if (window.appState.currentCardIndex >= window.appState.studyQueue.length) {
                    window.appState.studyQueue = [];
                    window.appState.currentCardIndex = 0;
                    app.navigate('dashboard');
                } else {
                    renderStudyCard();
                }
            }
        };

        function renderFeedbackView(result, correctAnswer, userAnswer) {
            window.appState.isShowingFeedback = true;
            const container = document.getElementById('interaction-area');
            if(!container) return;

            // Добавлены правильные padding'и для контейнера (в том числе снизу)
            container.className = 'flex-1 bg-stone-50/50 dark:bg-warm-base px-4 pt-4 overflow-y-auto transition-colors duration-300 flex flex-col relative';
            
            const isGood = result.isCorrect;
            const colorClass = isGood ? 'emerald' : 'rose';
            const icon = isGood ? 'ph-check-circle' : 'ph-x-circle';

            container.innerHTML = `
                <div class="fade-in flex flex-col min-h-full">
                    <!-- Оценка ИИ (Акцентный блок) -->
                    <div class="bg-white dark:bg-warm-surface border border-${colorClass}-200 dark:border-${colorClass}-500/30 rounded-3xl p-5 shadow-sm dark:shadow-none mb-4 relative overflow-hidden shrink-0">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-${colorClass}-500/10 rounded-bl-full -z-0 pointer-events-none"></div>
                        <div class="relative z-10 flex items-start justify-between gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <i class="ph-fill ${icon} text-xl text-${colorClass}-500 dark:text-${colorClass}-400"></i>
                                    <h3 class="font-bold text-stone-800 dark:text-white text-base">Анализ ИИ</h3>
                                </div>
                                <p class="text-stone-600 dark:text-stone-300 text-sm leading-relaxed">${escapeHtml(result.feedback)}</p>
                            </div>
                            <div class="shrink-0 flex flex-col items-center justify-center w-14 h-14 bg-${colorClass}-50 dark:bg-${colorClass}-500/10 rounded-2xl border border-${colorClass}-100 dark:border-${colorClass}-500/20 shadow-inner">
                                <span class="text-lg font-black text-${colorClass}-600 dark:text-${colorClass}-400">${result.score}</span>
                                <span class="text-[8px] font-bold text-${colorClass}-500 uppercase -mt-1 tracking-wider">Балл</span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3 mb-6 shrink-0">
                        <!-- Ваш ответ -->
                        <details class="group bg-white dark:bg-warm-surface border border-stone-200 dark:border-warm-border rounded-2xl shadow-sm dark:shadow-none overflow-hidden transition-all">
                            <summary class="flex items-center justify-between p-4 cursor-pointer list-none select-none hover:bg-stone-50 dark:hover:bg-warm-alt transition-colors outline-none">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-stone-100 dark:bg-warm-alt flex items-center justify-center text-stone-500 dark:text-stone-400">
                                        <i class="ph-fill ph-user text-base"></i>
                                    </div>
                                    <h3 class="font-bold text-stone-700 dark:text-stone-200 text-sm">Ваш ответ</h3>
                                </div>
                                <i class="ph-bold ph-caret-down text-stone-300 dark:text-stone-500 text-sm group-open:rotate-180 transition-transform"></i>
                            </summary>
                            <div class="px-4 pb-4 pt-1">
                                <div class="p-4 bg-stone-50 dark:bg-warm-alt rounded-xl border border-stone-100 dark:border-warm-border text-stone-600 dark:text-stone-300 text-sm leading-relaxed break-words">${escapeHtml(userAnswer)}</div>
                            </div>
                        </details>

                        <!-- Эталонный ответ -->
                        <details class="group bg-white dark:bg-warm-surface border border-stone-200 dark:border-warm-border rounded-2xl shadow-sm dark:shadow-none overflow-hidden transition-all">
                            <summary class="flex items-center justify-between p-4 cursor-pointer list-none select-none hover:bg-stone-50 dark:hover:bg-warm-alt transition-colors outline-none">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-amber-50 dark:bg-amber-500/10 flex items-center justify-center text-amber-500 dark:text-amber-400">
                                        <i class="ph-fill ph-star text-base"></i>
                                    </div>
                                    <h3 class="font-bold text-stone-700 dark:text-stone-200 text-sm">Эталонный ответ</h3>
                                </div>
                                <i class="ph-bold ph-caret-down text-stone-300 dark:text-stone-500 text-sm group-open:rotate-180 transition-transform"></i>
                            </summary>
                            <div class="px-4 pb-4 pt-1">
                                <div class="p-4 bg-amber-50/50 dark:bg-amber-500/5 rounded-xl border border-amber-100/50 dark:border-amber-500/10 text-stone-600 dark:text-stone-300 text-sm leading-relaxed break-words">${escapeHtml(correctAnswer)}</div>
                            </div>
                        </details>
                    </div>

                    ${result.followUp ? `
                    <!-- Доп. вопрос (чат-бот) -->
                    <div class="flex gap-3 mb-4 items-end slide-up shrink-0">
                         <div class="w-10 h-10 rounded-full bg-brand-main flex items-center justify-center shrink-0 shadow-lg shadow-brand-main/30 relative">
                             <i class="ph-fill ph-robot text-white text-lg relative z-10"></i>
                             <div class="absolute inset-0 bg-brand-main rounded-full animate-ping opacity-20"></div>
                         </div>
                         <div class="bg-white dark:bg-warm-surface border border-brand-main/20 dark:border-brand-main/30 p-4 rounded-[1.25rem] rounded-bl-none shadow-sm dark:shadow-none flex-1 relative overflow-hidden">
                             <div class="absolute top-0 right-0 w-16 h-16 bg-brand-main/5 rounded-bl-full -z-0 pointer-events-none"></div>
                             <span class="text-[10px] font-bold text-brand-main uppercase tracking-wider mb-1.5 flex items-center gap-1.5 relative z-10">
                                <i class="ph-fill ph-chat-teardrop-text text-sm"></i> Уточняющий вопрос
                             </span>
                             <p class="text-sm text-stone-700 dark:text-stone-200 font-medium leading-relaxed relative z-10">${escapeHtml(result.followUp)}</p>
                         </div>
                    </div>
                    ` : ''}

                    <!-- Липкий красивый футер с отступом -->
                    <div class="mt-auto pt-4 pb-5 sticky bottom-0 z-10 shrink-0 -mx-4 px-4 bg-stone-50/95 dark:bg-warm-base/95 backdrop-blur-sm border-t border-stone-200/50 dark:border-warm-border/50">
                        <button onclick="app.nextCard()" class="w-full bg-brand-main text-white py-4 rounded-2xl font-bold hover:bg-brand-hover transition-all shadow-lg shadow-brand-main/25 dark:shadow-none flex items-center justify-center gap-2 text-sm active:scale-95">
                            <span>Продолжить</span>
                            <i class="ph-bold ph-arrow-right text-lg"></i>
                        </button>
                    </div>
                </div>
            `;
            container.scrollTop = 0;
        }

        async function checkAnswerAI(userAns, refAns) {
            const apiKey = window.appState.groqKey;

            const calculateOverlap = () => {
                const clean = (s) => String(s).toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "").split(/\s+/).filter(Boolean);
                const u = clean(userAns);
                const r = clean(refAns);
                let matches = u.filter(t => r.includes(t)).length;
                let score = Math.round((matches / Math.max(r.length, 1)) * 100);
                if (score > 100) score = 100;
                return {
                    isCorrect: score > 40,
                    score: score,
                    feedback: score > 40 ? "Ключевые слова найдены (Оффлайн)." : "Ответ неполный (Оффлайн).",
                    followUp: null
                };
            };

            if (!apiKey) return calculateOverlap();

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); 

                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        messages: [
                            {
                                role: "system",
                                content: `You are a strict technical interviewer. Compare the user's answer to the reference based on meaning.
Output ONLY valid JSON with this structure:
{
    "score": <number 0-100>,
    "feedback": "<short russian comment, max 15 words>",
    "isCorrect": <boolean, true if score > 60>,
    "followUp": "<string or null. IF score is >= 50 AND score <= 70, write a short strict follow-up question in Russian to test deeper understanding. ELSE null>"
}`
                            },
                            {
                                role: "user",
                                content: `Reference: "${refAns}"\nUser Answer: "${userAns}"`
                            }
                        ],
                        model: "llama-3.3-70b-versatile",
                        temperature: 0.3,
                        max_tokens: 150,
                        response_format: { type: "json_object" }
                    }),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) throw new Error('AI Error: ' + response.status);
                const data = await response.json();
                const text = data.choices?.[0]?.message?.content;

                if (!text) throw new Error('Empty AI response');

                return JSON.parse(text);

            } catch (e) {
                console.warn("AI Failed, using fallback. Reason:", e);
                return calculateOverlap();
            }
        }

        function prepareStudySession(mode = 'all', listId = null) {
            let cards = [...window.appState.cards];
            
            switch (mode) {
                case 'new':
                    cards = cards.filter(c => (c.attempts || 0) === 0);
                    break;
                case 'mistakes':
                    cards = cards.filter(c => (c.incorrect || 0) > 0)
                                    .sort((a, b) => (b.incorrect || 0) - (a.incorrect || 0));
                    break;
                case 'learned':
                    cards = cards.filter(c => (c.correct || 0) > 2);
                    break;
                case 'list':
                    if (listId) cards = cards.filter(c => c.listId === listId);
                    break;
                case 'multi':
                    if (Array.isArray(listId)) {
                        cards = cards.filter(c => listId.includes(c.listId));
                    }
                    break;
                case 'smart':
                    cards = cards.filter(c => (c.correct || 0) <= 2);
                    break;
            }
            
            if (mode !== 'mistakes') {
                for (let i = cards.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [cards[i], cards[j]] = [cards[j], cards[i]];
                }
            }
            
            window.appState.studyQueue = cards;
            window.appState.currentCardIndex = 0;
        }

        function showToast(msg, isError = false) {
            const el = document.getElementById('toast');
            const txt = document.getElementById('toast-msg');
            txt.innerText = msg;
            el.className = `fixed top-20 left-1/2 transform -translate-x-1/2 px-4 py-2.5 rounded-full shadow-2xl transition-all duration-300 z-[70] flex items-center gap-2 font-medium text-sm w-max max-w-[90vw] backdrop-blur-md ${isError ? 'bg-rose-600/90 text-white' : 'bg-stone-800/90 dark:bg-white/90 text-white dark:text-stone-900'}`;
            requestAnimationFrame(() => {
                el.style.opacity = '1';
                el.style.transform = 'translate(-50%, 0)';
            });
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translate(-50%, -20px)';
            }, 3000);
        }

        function renderCardsItemsHTML() {
            let filteredCards = window.appState.cards;

            if (window.appState.activeListId && window.appState.activeListId !== 'all') {
                filteredCards = filteredCards.filter(c => c.listId === window.appState.activeListId);
            }

            const term = window.appState.searchTerm.toLowerCase();
            filteredCards = filteredCards.filter(c => 
                c.question.toLowerCase().includes(term) || 
                c.answer.toLowerCase().includes(term)
            );

            if (filteredCards.length === 0) {
                return `
                    <div class="text-center py-10 text-stone-400 dark:text-stone-500">
                        <i class="ph-light ph-files text-4xl mb-2"></i>
                        <p>В этом списке пока нет карточек</p>
                    </div>
                `;
            }

            return filteredCards.map(c => {
                const listName = window.appState.lists.find(l => l.id === c.listId)?.name || 'Без списка';

                return `
                    <div class="bg-white dark:bg-warm-surface p-5 rounded-2xl shadow-sm dark:shadow-none hover:shadow-md transition border border-stone-50 dark:border-warm-border group">
                        <div class="flex justify-between items-start gap-4">
                            <div class="flex-1 min-w-0">
                                <span class="text-[9px] font-bold text-stone-500 dark:text-stone-400 uppercase tracking-wider mb-1 block">${escapeHtml(listName)}</span>
                                
                                <h3 class="font-bold text-stone-800 dark:text-white text-base mb-1 truncate">${escapeHtml(c.question)}</h3>
                                <p class="text-stone-500 dark:text-stone-400 text-sm line-clamp-2 leading-relaxed">${escapeHtml(c.answer)}</p>
                            </div>
                            <div class="flex gap-2 shrink-0">
                                <button onclick="app.openEditModal('${c.id}')" class="w-8 h-8 rounded-lg bg-stone-100 dark:bg-warm-alt text-stone-500 dark:text-stone-400 flex items-center justify-center hover:bg-stone-200 dark:hover:bg-warm-border hover:text-stone-800 dark:hover:text-white transition">
                                    <i class="ph-bold ph-pencil-simple"></i>
                                </button>
                                <button onclick="app.resetCardProgress('${c.id}')" title="Сбросить прогресс" class="w-8 h-8 rounded-lg bg-stone-100 dark:bg-warm-alt text-stone-500 dark:text-stone-400 flex items-center justify-center hover:bg-amber-50 dark:hover:bg-amber-500/10 hover:text-amber-600 dark:hover:text-amber-500 transition">
                                    <i class="ph-bold ph-arrows-counter-clockwise"></i>
                                </button>
                                <button onclick="app.deleteCard('${c.id}')" class="w-8 h-8 rounded-lg bg-stone-100 dark:bg-warm-alt text-stone-500 dark:text-stone-400 flex items-center justify-center hover:bg-rose-50 dark:hover:bg-rose-500/10 hover:text-rose-600 dark:hover:text-rose-500 transition">
                                    <i class="ph-bold ph-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-stone-50 dark:border-warm-border flex items-center flex-wrap gap-2">
                            <span class="text-[10px] font-bold bg-stone-100 dark:bg-warm-alt text-stone-500 dark:text-stone-400 px-2 py-1 rounded-md">Всего: ${c.attempts || 0}</span>
                            <span class="text-[10px] font-bold bg-emerald-50 dark:bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 px-2 py-1 rounded-md flex items-center gap-1">
                                <i class="ph-bold ph-check"></i> ${c.correct || 0}
                            </span>
                            <span class="text-[10px] font-bold bg-rose-50 dark:bg-rose-500/10 text-rose-600 dark:text-rose-400 px-2 py-1 rounded-md flex items-center gap-1">
                                <i class="ph-bold ph-x"></i> ${c.incorrect || 0}
                            </span>
                            
                            ${(c.correct || 0) > 2 ? `
                                <span class="text-[10px] font-semibold bg-stone-100 dark:bg-warm-alt text-stone-600 dark:text-stone-300 px-2 py-1 rounded-md flex items-center gap-1 ml-auto">
                                    <i class="ph-fill ph-seal-check"></i> Освоено
                                </span>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function render() {
            const container = document.getElementById('main-container');
            const view = window.appState.currentView;
            
            document.querySelectorAll('.nav-item, .mob-nav-item').forEach(el => {
                // Очистка активных классов
                el.classList.remove('bg-stone-50', 'text-stone-900', 'bg-stone-100', 'dark:bg-warm-alt', 'dark:text-white'); 
                
                if(el.classList.contains('nav-item')) {
                    el.classList.add('text-stone-500', 'dark:text-stone-400');
                }
                if(el.classList.contains('mob-nav-item')) {
                    el.classList.add('text-stone-400', 'dark:text-stone-500');
                }
            });
            
            const activeDesktop = document.getElementById(`nav-${view}`);
            const activeMobile = document.getElementById(`mob-nav-${view}`);
            
            if(activeDesktop) {
                activeDesktop.classList.remove('text-stone-500', 'dark:text-stone-400');
                activeDesktop.classList.add('bg-stone-50', 'text-stone-900', 'dark:bg-warm-alt', 'dark:text-white');
            }
            if(activeMobile) {
                activeMobile.classList.remove('text-stone-400', 'dark:text-stone-500');
                activeMobile.classList.add('text-stone-900', 'dark:text-white');
            }

            if (view === 'dashboard') {
                const { total, learned, accuracy, chartData } = window.appState.stats;
                const period = window.appState.chartPeriod || 7;
                const rawMax = Math.max(...chartData.map(d => d.totalCount), 1);
                const maxCount = rawMax > 10 ? Math.ceil(rawMax / 5) * 5 : rawMax;

                const steps = 5;
                const yAxisLabels = [];
                for (let i = steps; i >= 0; i--) {
                    yAxisLabels.push(Math.round((maxCount / steps) * i));
                }

                const now = new Date();
                const startOfToday = new Date(now.setHours(0,0,0,0)).getTime() / 1000;
                const cardsReviewedToday = window.appState.cards.filter(c => 
                    c.lastReviewed && c.lastReviewed.seconds >= startOfToday
                ).length;

                const dailyGoal = 20;
                const goalPercent = Math.min((cardsReviewedToday / dailyGoal) * 100, 100);

                container.innerHTML = `
                    <div class="max-w-md mx-auto fade-in pt-14 md:pt-10 px-4 min-h-[101%]">
                        <h1 class="text-2xl font-bold text-stone-800 dark:text-white mb-6 px-2 mt-6">Обзор</h1>

                        <div class="bg-white dark:bg-warm-surface rounded-[2rem] shadow-xl shadow-stone-200/25 dark:shadow-none p-6 mb-6 border border-stone-50 dark:border-warm-border fade-in transition-colors">
                            <div class="flex justify-between items-end mb-4">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <div class="w-2 h-2 rounded-full bg-brand-main animate-pulse"></div>
                                        <p class="text-[10px] font-black uppercase tracking-widest text-brand-main">Цель на сегодня</p>
                                    </div>
                                    <h3 class="text-2xl font-bold text-stone-800 dark:text-white">
                                        ${cardsReviewedToday} <span class="text-stone-300 dark:text-stone-600 font-medium text-lg">/ ${dailyGoal}</span>
                                    </h3>
                                </div>
                                <div class="text-right">
                                    <span class="text-sm font-black text-brand-main opacity-50">${Math.round(goalPercent)}%</span>
                                </div>
                            </div>
                            
                            <div class="w-full bg-brand-light dark:bg-brand-main/20 h-4 rounded-2xl overflow-hidden border border-brand-light dark:border-transparent relative">
                                <div class="bg-gradient-to-r from-brand-gradStart to-brand-main h-full transition-all duration-1000 ease-out rounded-2xl" 
                                     style="width: ${goalPercent}%">
                                    <div class="absolute inset-0 bg-white/20 w-1/2 -skew-x-12 animate-[shimmer_2s_infinite]"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-warm-surface rounded-[2rem] shadow-xl shadow-stone-200/25 dark:shadow-none p-5 md:p-6 border border-stone-50 dark:border-warm-border transition-colors">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <span class="text-stone-500/75 dark:text-stone-400/75 text-sm uppercase tracking-tight px-2">Аналитика</span>
                                </div>
                                <div class="flex bg-stone-100 dark:bg-warm-alt rounded-lg p-1 gap-1">
                                    <button onclick="app.setChartPeriod(7)" class="text-xs px-2.5 py-1 rounded-md font-semibold transition ${period === 7 ? 'bg-white dark:bg-warm-surface text-stone-800 dark:text-white shadow-sm dark:shadow-none' : 'text-stone-400 dark:text-stone-500 hover:text-stone-600 dark:hover:text-stone-300'}">7</button>
                                    <button onclick="app.setChartPeriod(14)" class="text-xs px-2.5 py-1 rounded-md font-semibold transition ${period === 14 ? 'bg-white dark:bg-warm-surface text-stone-800 dark:text-white shadow-sm dark:shadow-none' : 'text-stone-400 dark:text-stone-500 hover:text-stone-600 dark:hover:text-stone-300'}">14</button>
                                    <button onclick="app.setChartPeriod(30)" class="text-xs px-2.5 py-1 rounded-md font-semibold transition ${period === 30 ? 'bg-white dark:bg-warm-surface text-stone-800 dark:text-white shadow-sm dark:shadow-none' : 'text-stone-400 dark:text-stone-500 hover:text-stone-600 dark:hover:text-stone-300'}">30</button>
                                </div>
                            </div>
                            
                            <div class="h-40 flex items-end justify-around gap-px mb-8 px-5 border-b border-stone-100 dark:border-warm-border pb-2">
                                ${chartData.map((d, i) => {
                                    const isToday = i === chartData.length - 1;
                                    const showLabel = period === 7 || (period > 7 && d.day % 5 === 0) || isToday;
                                    const hLearned = (d.learnedCount / maxCount) * 100;
                                    const hRepeated = (d.repeatedCount / maxCount) * 100;
                                    const barWidth = period === 7 ? 'w-full max-w-[24px]' : (period === 14 ? 'w-2.5' : 'w-1.5');

                                    return `
                                    <div class="flex-1 flex flex-col items-center gap-2 h-40 justify-end">
                                        <div class="${barWidth} flex flex-col justify-end bg-stone-100 dark:bg-warm-alt rounded-t-sm overflow-hidden h-32">
                                            <div class="w-full bg-amber-300 dark:bg-amber-500 transition-all duration-1000 flex items-center justify-center text-[7px] font-black text-amber-900/60 dark:text-amber-950" 
                                                 style="height: ${hRepeated}%; min-height: ${d.repeatedCount > 0 ? '10px' : '0'};" 
                                                 title="Повторено: ${d.repeatedCount}">
                                                 ${period < 30 && d.repeatedCount > 0 ? d.repeatedCount : ''}
                                            </div>
                                            <div class="w-full bg-brand-gradStart transition-all duration-1000 flex items-center justify-center text-[7px] font-black text-white" 
                                                 style="height: ${hLearned}%; min-height: ${d.learnedCount > 0 ? '10px' : '0'};" 
                                                 title="Выучено: ${d.learnedCount}">
                                                 ${period < 30 && d.learnedCount > 0 ? d.learnedCount : ''}
                                            </div>
                                        </div>
                                        <span class="text-[8px] font-bold text-stone-400 dark:text-stone-500 transition-opacity duration-300 ${showLabel ? 'opacity-100' : 'opacity-0'}">${d.day}</span>
                                    </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-3.5 h-3.5 rounded bg-amber-300 dark:bg-amber-500 shadow-sm shadow-amber-200 dark:shadow-none"></div>
                                        <span class="text-stone-600 dark:text-stone-300 font-medium text-sm">Прогресс повторения</span>
                                    </div>
                                    <span class="font-bold text-stone-800 dark:text-white text-base">${total}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-3.5 h-3.5 rounded bg-brand-gradStart shadow-sm shadow-brand-light dark:shadow-none"></div>
                                        <span class="text-stone-600 dark:text-stone-300 font-medium text-sm">Выучено</span>
                                    </div>
                                    <span class="font-bold text-stone-800 dark:text-white text-base">${learned}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <div class="w-3.5 h-3.5 rounded bg-stone-300 dark:bg-stone-600 shadow-sm shadow-stone-200 dark:shadow-none"></div>
                                        <span class="text-stone-600 dark:text-stone-300 font-medium text-sm">Точность</span>
                                    </div>
                                    <span class="font-bold text-stone-800 dark:text-white text-base">${accuracy}%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mt-8 px-2">
                            <button onclick="app.openAddModal()" class="bg-white dark:bg-warm-surface text-stone-700 dark:text-stone-200 py-4 rounded-2xl font-bold shadow-sm dark:shadow-none border border-stone-200 dark:border-warm-border active:scale-95 transition flex flex-col items-center justify-center gap-1 text-[11px] uppercase tracking-wider">
                                <i class="ph-bold ph-plus-circle text-xl"></i> 
                                <span>Добавить</span>
                            </button>
                            <button onclick="app.navigate('study')" class="bg-brand-main text-white py-4 rounded-2xl font-bold shadow-lg shadow-brand-main/25 dark:shadow-none active:scale-95 transition flex flex-col items-center justify-center gap-1 text-[11px] uppercase tracking-wider">
                                <i class="ph-bold ph-play-circle text-xl"></i> 
                                <span>Учить</span>
                            </button>
                        </div>
                    </div>
                `;
            }

            else if (view === 'cards') {
                const activeId = window.appState.activeListId;
                
                container.innerHTML = `
                    <div class="max-w-md mx-auto fade-in pt-14 md:pt-10 px-4">
                        <div class="flex items-center justify-between mb-6 mt-6 px-2">
                            <h1 class="text-2xl font-bold text-stone-800 dark:text-white">Карточки</h1>
                            <button onclick="app.openListModal()" class="text-stone-500 dark:text-stone-400 hover:text-stone-900 dark:hover:text-white transition flex items-center gap-1.5 text-sm font-bold">
                                <i class="ph-bold ph-plus-circle text-lg"></i>
                                <span>Список</span>
                            </button>
                        </div>

                        <div class="flex gap-2 overflow-x-auto pb-4 mb-4 no-scrollbar -mx-2 px-2">
                            <button onclick="app.setActiveList('all')" 
                                class="px-5 py-2 rounded-xl whitespace-nowrap text-xs font-bold transition-all ${activeId === 'all' ? 'bg-brand-main text-white shadow-md dark:shadow-none' : 'bg-white dark:bg-warm-surface text-stone-500 dark:text-stone-400 border border-stone-100 dark:border-warm-border'}">
                                Все
                            </button>
                            ${window.appState.lists.map(l => `
                                <div class="relative flex-shrink-0 group">
                                    <button onclick="app.setActiveList('${l.id}')" 
                                        class="pl-4 pr-10 py-2 rounded-xl whitespace-nowrap text-xs font-bold transition-all ${activeId === l.id ? 'bg-brand-main text-white shadow-md dark:shadow-none' : 'bg-white dark:bg-warm-surface text-stone-500 dark:text-stone-400 border border-stone-100 dark:border-warm-border'}">
                                        ${escapeHtml(l.name)}
                                    </button>
                                    <button onclick="event.stopPropagation(); app.openConfirmModal('deleteList', '${l.id}')" 
                                        class="absolute right-2 top-1/2 -translate-y-1/2 w-6 h-6 rounded-lg flex items-center justify-center transition-colors ${activeId === l.id ? 'text-white/50 hover:text-white' : 'text-stone-300 dark:text-stone-600 hover:text-rose-500 dark:hover:text-rose-400'}">
                                        <i class="ph ph-x text-[10px]"></i>
                                    </button>
                                </div>
                            `).join('')}
                        </div>

                        <div class="relative mb-6">
                            <i class="ph ph-magnifying-glass absolute left-4 top-1/2 -translate-y-1/2 text-stone-400 dark:text-stone-500 text-lg"></i>
                            <input type="text" oninput="app.setSearchTerm(this.value)" value="${window.appState.searchTerm}" 
                                class="w-full pl-11 pr-4 py-3 bg-stone-100/50 dark:bg-warm-alt border border-transparent dark:border-warm-border rounded-2xl focus:bg-white dark:focus:bg-warm-surface focus:ring-2 focus:ring-brand-main/50 outline-none transition-all text-sm placeholder-stone-400 dark:placeholder-stone-500 dark:text-white" 
                                placeholder="Поиск в этом списке...">
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-8">
                            <button onclick="app.openAddModal()" class="flex items-center justify-center gap-2 bg-brand-main border border-transparent text-white py-3.5 rounded-2xl font-bold text-xs hover:bg-brand-hover transition shadow-sm dark:shadow-none active:scale-95">
                                <i class="ph-bold ph-plus text-base text-white"></i> Добавить
                            </button>
                            <button onclick="app.openBulkModal()" class="flex items-center justify-center gap-2 bg-white dark:bg-warm-surface border border-stone-200 dark:border-warm-border text-stone-700 dark:text-stone-200 py-3.5 rounded-2xl font-bold text-xs hover:bg-stone-50 dark:hover:bg-warm-alt transition shadow-sm dark:shadow-none active:scale-95">
                                <i class="ph-bold ph-file-arrow-up text-base text-stone-400 dark:text-stone-500"></i> Импорт
                            </button>
                        </div>

                        <div id="cards-list-container" class="space-y-3">
                            ${renderCardsItemsHTML()} 
                        </div>
                    </div>
                `;
            }

            else if (view === 'study') {
                if (!window.appState.isDataLoaded) {
                    container.innerHTML = `<div class="h-full flex flex-col items-center justify-center"><i class="ph-light ph-spinner animate-spin text-4xl text-stone-400 dark:text-stone-500 mb-4"></i></div>`;
                    return;
                }

                if (window.appState.showResumeChoice) {
                    renderResumeChoice(container); 
                    return;
                }

                if (window.appState.studyQueue.length === 0) {
                    renderLobby(container);
                    return;
                }

                if (!window.appState.isShowingFeedback) {
                    renderStudyCard();
                }
            }

            else if (view === 'settings') {
                const user = window.appState.user || {};

                container.innerHTML = `
                    <div class="max-w-md mx-auto fade-in pt-14 md:pt-10 px-4">
                        <h1 class="text-2xl font-bold text-stone-800 dark:text-white mb-6 px-2 mt-6">Настройки</h1>
                        
                        <div class="space-y-6">
                            
                            <!-- Тема (Светлая / Темная / Акцент) -->
                            <div class="bg-white dark:bg-warm-surface rounded-[2rem] shadow-xl shadow-stone-200/50 dark:shadow-none p-8 space-y-6 border border-stone-50 dark:border-warm-border">
                                
                                <div>
                                    <h3 class="text-xs font-bold text-stone-400 dark:text-stone-500 uppercase tracking-wider mb-3 ml-1">Режим</h3>
                                    <div class="flex gap-4">
                                        <button onclick="app.setColorMode('light')" class="flex-1 py-3 rounded-xl font-bold text-sm transition-all border ${window.appState.colorMode === 'light' ? 'bg-stone-900 text-white border-stone-900 dark:bg-white dark:text-stone-900 dark:border-white' : 'bg-transparent text-stone-500 border-stone-200 dark:border-warm-border dark:text-stone-400 hover:bg-stone-50 dark:hover:bg-warm-alt'}">
                                            <i class="ph-fill ph-sun mr-2"></i> Светлая
                                        </button>
                                        <button onclick="app.setColorMode('dark')" class="flex-1 py-3 rounded-xl font-bold text-sm transition-all border ${window.appState.colorMode === 'dark' ? 'bg-stone-900 text-white border-stone-900 dark:bg-white dark:text-stone-900 dark:border-white' : 'bg-transparent text-stone-500 border-stone-200 dark:border-warm-border dark:text-stone-400 hover:bg-stone-50 dark:hover:bg-warm-alt'}">
                                            <i class="ph-fill ph-moon mr-2"></i> Темная
                                        </button>
                                    </div>
                                </div>

                                <div>
                                    <h3 class="text-xs font-bold text-stone-400 dark:text-stone-500 uppercase tracking-wider mb-3 ml-1">Цвет акцента</h3>
                                    <div class="flex gap-4">
                                        ${['emerald', 'blue', 'violet', 'rose', 'amber'].map(t => `
                                            <button onclick="app.setTheme('${t}')" class="w-12 h-12 rounded-2xl flex items-center justify-center transition-all ${window.appState.theme === t ? 'ring-4 ring-offset-2 ring-stone-200 dark:ring-stone-600 dark:ring-offset-warm-surface scale-105' : 'hover:scale-105'}" style="background-color: ${app.getThemeHex(t)}">
                                                ${window.appState.theme === t ? '<i class="ph-bold ph-check text-white text-xl"></i>' : ''}
                                            </button>
                                        `).join('')}
                                    </div>
                                </div>

                            </div>

                            <div class="bg-white dark:bg-warm-surface rounded-[2rem] shadow-xl shadow-stone-200/50 dark:shadow-none overflow-hidden border border-stone-50 dark:border-warm-border transition-colors">
                                <div class="p-8 bg-brand-main text-white transition-colors duration-300">
                                    <div class="flex items-center gap-4 mb-2">
                                         <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
                                            <i class="ph-fill ph-robot text-2xl"></i>
                                         </div>
                                         <h2 class="text-xl font-bold">Groq AI</h2>
                                    </div>
                                    <p class="text-white/90 text-sm leading-relaxed">Бесплатный API для проверки ответов (Llama 3).</p>
                                </div>
                                
                                <div class="p-8 space-y-4">
                                    <div>
                                        <label class="block text-sm font-bold text-stone-700 dark:text-stone-300 mb-2 ml-1">Groq API Key</label>
                                        <div class="relative">
                                            <i class="ph-bold ph-key absolute left-4 top-2.5 text-stone-400 dark:text-stone-500 text-lg"></i>
                                            <input type="password" id="api-key-input" value="${window.appState.groqKey}" 
                                                class="w-full pl-11 pr-4 py-3 bg-stone-50 dark:bg-warm-alt border border-stone-200 dark:border-warm-border rounded-xl focus:bg-white dark:focus:bg-warm-surface focus:ring-2 focus:ring-brand-main/50 outline-none transition font-mono text-sm dark:text-white placeholder-stone-400 dark:placeholder-stone-500" 
                                                placeholder="gsk_...">
                                        </div>
                                    </div>
                                    <button onclick="app.saveSettings()" class="w-full bg-brand-main text-white py-3.5 rounded-xl hover:bg-brand-hover transition font-bold text-sm shadow-lg shadow-brand-main/25 dark:shadow-none">
                                        Сохранить настройки
                                    </button>
                                </div>
                            </div>

                            <div class="bg-white dark:bg-warm-surface rounded-[2rem] shadow-xl shadow-stone-200/50 dark:shadow-none p-8 space-y-4 border border-stone-50 dark:border-warm-border">
                                <h3 class="text-xs font-bold text-stone-400 dark:text-stone-500 uppercase tracking-wider mb-2 ml-1">Аккаунт</h3>
                                
                                <div class="p-4 bg-stone-50 dark:bg-warm-alt rounded-xl border border-stone-100 dark:border-warm-border mb-4">
                                    <p class="text-[10px] text-stone-400 dark:text-stone-500 uppercase font-black mb-1">Email</p>
                                    <p class="text-sm font-semibold text-stone-800 dark:text-white">${user.email || 'Анонимный пользователь'}</p>
                                </div>

                                <button onclick="app.handleLogout()" class="w-full flex items-center justify-between px-5 py-4 bg-stone-50 dark:bg-warm-alt hover:bg-stone-100 dark:hover:bg-warm-border text-stone-700 dark:text-stone-300 rounded-2xl transition group border border-stone-100 dark:border-warm-border">
                                    <div class="flex items-center gap-3">
                                        <i class="ph-bold ph-sign-out text-xl"></i>
                                        <span class="font-bold text-sm">Выйти из аккаунта</span>
                                    </div>
                                    <i class="ph-bold ph-caret-right text-xs opacity-30 group-hover:opacity-100"></i>
                                </button>
                            </div>

                            <div class="bg-white dark:bg-warm-surface rounded-[2rem] shadow-xl shadow-stone-200/50 dark:shadow-none p-8 space-y-4 border border-stone-50 dark:border-warm-border">
                                <h3 class="text-xs font-bold text-rose-500 dark:text-rose-400 uppercase tracking-wider mb-2 ml-1">Опасная зона</h3>
                                
                                <button onclick="app.openConfirmModal('reset')" class="w-full flex items-center justify-between px-5 py-4 bg-stone-50 dark:bg-warm-alt hover:bg-amber-50 dark:hover:bg-amber-500/10 text-stone-700 dark:text-stone-300 hover:text-amber-700 dark:hover:text-amber-500 rounded-2xl transition group border border-stone-100 dark:border-warm-border">
                                    <div class="flex items-center gap-3">
                                        <i class="ph-bold ph-arrows-counter-clockwise text-xl"></i>
                                        <span class="font-bold text-sm">Обнулить прогресс</span>
                                    </div>
                                    <i class="ph-bold ph-caret-right text-xs opacity-30 group-hover:opacity-100"></i>
                                </button>

                                <button onclick="app.openConfirmModal('delete')" class="w-full flex items-center justify-between px-5 py-4 bg-stone-50 dark:bg-warm-alt hover:bg-rose-50 dark:hover:bg-rose-500/10 text-stone-700 dark:text-stone-300 hover:text-rose-700 dark:hover:text-rose-400 rounded-2xl transition group border border-stone-100 dark:border-warm-border">
                                    <div class="flex items-center gap-3">
                                        <i class="ph-bold ph-trash text-xl"></i>
                                        <span class="font-bold text-sm">Удалить все карточки</span>
                                    </div>
                                    <i class="ph-bold ph-caret-right text-xs opacity-30 group-hover:opacity-100"></i>
                                </button>
                            </div>
                            
                            <div class="text-center pb-4">
                                 <a href="https://console.groq.com/keys" target="_blank" class="inline-flex items-center gap-2 text-xs text-stone-400 dark:text-stone-500 font-medium hover:text-stone-600 dark:hover:text-stone-300 transition">
                                    <span>Получить бесплатный Groq Key</span>
                                    <i class="ph-bold ph-arrow-square-out"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function renderStudyCard() {
            const container = document.getElementById('main-container');
            const card = window.appState.studyQueue[window.appState.currentCardIndex];
            const currentIndex = window.appState.currentCardIndex;
            const total = window.appState.studyQueue.length;
            const progress = ((currentIndex) / total) * 100;

            container.innerHTML = `
                <div class="max-w-md mx-auto h-full flex flex-col pb-2 pt-14 md:pt-10">
                    <div class="mx-6 mb-2 mt-4 flex items-center justify-between shrink-0 h-12">
                        <button onclick="app.exitStudy()" class="w-12 h-12 -ml-3 flex items-center justify-center text-stone-400 dark:text-stone-500 hover:text-stone-600 dark:hover:text-stone-300 transition-colors">
                            <i class="ph-bold ph-caret-left text-2xl"></i>
                        </button>
                        <div class="flex-1 max-w-[400px] mx-auto bg-brand-light dark:bg-brand-main/20 h-3 rounded-2xl overflow-hidden border border-brand-light dark:border-transparent relative">
                            <div class="bg-gradient-to-r from-brand-gradStart to-brand-main h-full transition-all duration-700 ease-out rounded-2xl" style="width: ${progress}%"></div>
                        </div>
                        <span class="text-[11px] font-black uppercase tracking-tighter text-stone-500 dark:text-stone-500 w-12 text-right">
                            ${currentIndex + 1}/${total}
                        </span>
                    </div>

                    <div id="study-card-main" class="mx-4 bg-white dark:bg-warm-surface rounded-[2rem] shadow-xl dark:shadow-none border border-stone-100 dark:border-warm-border overflow-hidden flex flex-col flex-1 relative min-h-0 mb-1 card-enter transition-colors">
                        <div class="p-6 md:p-8 border-b border-stone-50 dark:border-warm-border bg-white dark:bg-warm-surface shrink-0 flex items-center justify-center min-h-[25%] transition-colors">
                            <h2 class="text-xl md:text-2xl font-bold text-stone-800 dark:text-white text-center leading-tight">${escapeHtml(card.question)}</h2>
                        </div>

                        <div id="interaction-area" class="flex-1 bg-stone-50/50 dark:bg-warm-base p-4 flex flex-col min-h-0 transition-colors">
                            <div class="flex flex-col gap-3 h-full">
                                <textarea id="study-input" class="w-full flex-1 p-4 bg-white dark:bg-warm-alt border-none rounded-xl focus:ring-2 focus:ring-brand-main/50 outline-none transition text-base resize-none shadow-sm dark:shadow-none dark:text-white placeholder-stone-400 dark:placeholder-stone-500" placeholder="Ваш ответ..."></textarea>
                                
                                <div class="grid grid-cols-3 gap-2 shrink-0">
                                    <button onclick="app.skipCard()" class="col-span-1 bg-white dark:bg-warm-alt text-stone-400 dark:text-stone-500 py-3 rounded-xl font-bold hover:bg-stone-50 dark:hover:bg-warm-border transition text-xs border border-stone-100 dark:border-warm-border">
                                        Пропуск
                                    </button>
                                    <button id="submit-btn" onclick="app.submitAnswer()" class="col-span-2 bg-brand-main text-white py-3 rounded-xl font-bold hover:bg-brand-hover transition shadow-md dark:shadow-none flex items-center justify-center gap-2 text-sm">
                                        <span id="submit-btn-text">Проверить</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            setTimeout(() => document.getElementById('study-input')?.focus(), 100);
        }

    </script>
</body>
</html>